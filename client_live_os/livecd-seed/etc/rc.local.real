#!/bin/bash


/bin/bash -c 'dhclient ; hostname client-$(ifconfig |grep inet |grep -v inet6|grep -v "127\." |cut -dn -f2|cut -d\. -f4|sed "s/ //g;s/\t//g") ' > /dev/shm/log.boot.1.dhcp &


(
  ##chrome subshell

/bin/bash -c '( cd /dev/shm;wget -c  -O- http://printserver.local/chrome.tgz |tar xvz;chmod a+x chrome.bin ;ln -s /dev/shm/chrome.bin /usr/bin/chromium;ln -s /dev/shm/chrome.bin /usr/bin/chrome )' 
update-alternatives --install /usr/bin/x-www-browser x-www-browser /usr/bin/chrome 200;
update-alternatives --set x-www-browser /usr/bin/chrome
#sudo -u guest -i update-alternatives --install /usr/bin/x-www-browser x-www-browser /usr/bin/chrome 200;
sudo -u guest -i update-alternatives --set x-www-browser /usr/bin/chrome

) > /dev/shm/log.boot.3.chromeloader & 

# set random root pass
rpa=$(for rounds in $(seq 1 24);do tr -cd '[:alnum:]_\-.' < /dev/urandom  |head -c48;echo ;done|grep -e "_" -e "\-" -e "\."|grep "^[a-zA-Z0-9]"|grep "[a-zA-Z0-9]$"|tail -n1)
echo "root:$rpa" |chpasswd &


## hide terminal
mv /usr/bin/xterm /usr/bin/andterm &

(apt-get update && apt-get install -y ca-certificates) &> /dev/shm/log.boot.2.cacerts & 

( 
cd /usr/share/applications && (
  rm *connman* *pcmanfm* lftp.desktop xarchiver.desktop *terminal*
  sed 's/^Exec=.\+/Exec=su guest -c "bash  /dev/shm/.chromecmd"/g' -i *hromium*
 )
) & 


(
mkdir /etc/chromium.d
echo '
# Disable set default browser
export CHROMIUM_FLAGS="$CHROMIUM_FLAGS --no-default-browser-check"' | tee /etc/chromium.d/disable-set-default-browser 
) & 

#(
#test -e "$HOME/.ssh"||mkdir  "$HOME/.ssh"
#    curl http://printserver.local/authorized_keys >  "$HOME/.ssh/authorized_keys"
#    chmod 0600  "$HOME/.ssh"  "$HOME/.ssh/authorized_keys"
#) &



## select analogue device with analogue output ( in case of digital outs)
( aplay -l|grep Analog|grep -v Digital|sed 's/^card /defaults.pcm.card /g;s/:.\+device /\ndefaults.pcm.device /g'|cut -d":" -f1 > /etc/asound.conf ) &

(
##load timezone from kernel cmdline parsed above and sync
if [ -z "$timez" ];then timez="Europe/Berlin";else echo timezone set from kernel args;fi
/bin/bash -c '( timedatectl set-timezone "$timez" ;sleep 5; ntpdate-debian ntp.ubuntu.com   || ntpdate time.windows.com  || ntpdate 0.lede.pool.ntp.org ) ' > /dev/shm/log.boot.3.time &

) & 

(

echo 'IyEvYmluL2Jhc2gKc2xlZXAgMQoKCmtleXo9IiI7cmVzPSIiO3RpbWV6PSIiO2xvYWRzaXRlPSIiOwoKCnNldCAtLSAkKGNhdCAvcHJvYy9jbWRsaW5lKQpmb3IgeCBpbiAiJEAiOyBkbwogICAgY2FzZSAiJHgiIGluCiAgICAgICAgdGltZXpvbmU9KikKICAgICAgICBlY2hvICIke3gjdGltZXpvbmU9fSIKICAgICAgICB0aW1lej0iJHt4I3RpbWV6b25lPX0iCiAgICAgICAgOzsKCiAgICAgICAga21hcD0qKQogICAgICAgIGVjaG8gIiR7eCNrbWFwPX0iCiAgICAgICAga2V5ej0iJHt4I2ttYXA9fSIKICAgICAgICA7OwoKICAgICAgICB4cmFuZHI9KikKICAgICAgICBlY2hvICIke3gjeHJhbmRyPX0iCiAgICAgICAgcmVzPSIke3gjeHJhbmRyPX0iCiAgICAgICAgOzsKCiAgICAgICAgc3BsYXNodXJsPSopCiAgICAgICAgZWNobyAiJHt4I3NwbGFzaHVybD19IgogICAgICAgIGxvYWRzaXRlPSIke3gjc3BsYXNodXJsPX0iCiAgICAgICAgOzsKCiAgICBlc2FjCmRvbmUKCgoKaWYgWyAteiAka2V5eiBdO3RoZW4ga2V5ej1kZTtlbHNlIGVjaG8ga2V5bWFwIHNldCBmcm9tIGtlcm5lbCBhcmdzO2ZpCkRJU1BMQVk9OjAgc2V0eGtibWFwICIka2V5eiIKCmVjaG8gIiRrZXl6IiA+IH4vLmZsdXhib3gva2JsYXlvdXQKRElTUExBWT06MCBmYnNldGtiICIka2V5eiIKRElTUExBWT06MCBzZXR4a2JtYXAgIiRrZXl6IgoKIyMgRW5hYmxlIFRhcCB0byBDbGljawpmb3IgdG91Y2hwYWQgaW4gJChESVNQTEFZPTowIHhpbnB1dCBsaXN0fGdyZXAgLWUgIkFMUFMiIC1lICJBbHBzUFMiIC1lIFRvdWNoUGFkIC1lIFRvdWNocGFkIC1lIHRvdWNocGFkIHxzZWQgJ3MvLlwraWQ9Ly9nJ3xjdXQgLWYxKTtkbyBESVNQTEFZPTowIHhpbnB1dCBsaXN0LXByb3BzICR0b3VjaHBhZHxncmVwICJUYXBwaW5nIEVuYWJsZWQifGdyZXAgLXYgRGVmYXVsdCB8Y3V0IC1kIigiIC1mMiB8Y3V0IC1kIikiIC1mMXx3aGlsZSByZWFkIGlkO2RvIGVjaG8gc2V0dGluZyB0YXB0b2NsaWNrICR0b3VjaHBhZCAkaWQ7IERJU1BMQVk9OjAgeGlucHV0IHNldC1wcm9wICR0b3VjaHBhZCAkaWQgMTtkb25lO2RvbmUKCmFwbGF5IC91c3Ivc2hhcmUvc291bmRzL3NodXRkb3duLndhdgo='|base64 -d > /etc/fix-mouse-key.sh

chmod +x /etc/fix-mouse-key.sh

##setup udev hotplug rule
echo 'ACTION=="add", SUBSYSTEM=="usb", KERNEL=="*", ATTRS{model}=="*Barcode*", RUN+="sh /etc/fix-mouse-key.sh"' > /etc/udev/rules.d/90-local.rules
echo 'ACTION=="add", ATTRS{idVendor}=="0c2e", ATTRS{idProduct}=="0b81", ENV{XAUTHORITY}="/root/.Xauthority", ENV{DISPLAY}=":0", OWNER="root", RUN+="/etc/fix-mouse-key.sh"' >> /etc/udev/rules.d/90-local.rules

service udev restart

) &

test -e /etc/rc.local.custom && bash /etc/rc.local.custom
exit 0
